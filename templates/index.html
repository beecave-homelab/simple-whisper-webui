<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Audio Transcription</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  </head>
  <body>
    <div class="container mt-5">
      <h1>Upload Audio File for Transcription</h1>
      <form id="upload-form" enctype="multipart/form-data">
        <div class="form-group">
          <label for="domain">Domain</label>
          <input type="text" class="form-control" id="domain" name="domain" placeholder="http://localhost:8000">
        </div>
        <div class="form-group">
          <label for="audio_file">Audio File</label>
          <input type="file" class="form-control-file" id="audio_file" name="audio_file">
        </div>
        <button type="submit" class="btn btn-primary">Upload</button>
      </form>
      <div class="mt-3">
        <h3>Transcript</h3>
        <textarea class="form-control" id="transcript" rows="10" readonly></textarea>
        <button class="btn btn-secondary mt-2" onclick="copyToClipboard()">Copy to Clipboard</button>
      </div>
      <div class="mt-3">
        <h3>Progress</h3>
        <div class="progress">
          <div class="progress-bar" role="progressbar" id="progress-bar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
      function copyToClipboard() {
        var transcript = document.getElementById("transcript");
        transcript.select();
        document.execCommand("copy");
      }

      $(document).ready(function () {
        $('#upload-form').on('submit', function (e) {
          e.preventDefault();
          var formData = new FormData(this);
          $.ajax({
            url: '/transcribe',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
              $('#transcript').text(data.transcript);
              clearInterval(progressInterval); // Clear progress interval
            },
            error: function (xhr, status, error) {
              alert("An error occurred: " + error);
              clearInterval(progressInterval); // Clear progress interval
            }
          });

          // Start progress check
          var progressInterval = setInterval(function() {
            $.ajax({
              url: '/progress',
              type: 'GET',
              success: function (data) {
                var progress = data.progress;
                $('#progress-bar').css('width', progress + '%').attr('aria-valuenow', progress);
                if (progress >= 100) {
                  clearInterval(progressInterval); // Clear progress interval
                }
              }
            });
          }, 1000);
        });
      });
    </script>
  </body>
</html>
